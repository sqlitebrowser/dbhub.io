[[ define "visualisePage" ]]
<!doctype html>
<html ng-app="DBHub" ng-controller="visualiseView">
[[ template "head" . ]]
<body>
<script src="/js/plotly-1.53.0.min.js"></script>
[[ template "header" . ]]
<div style="margin-left: 2%; margin-right: 2%; padding-left: 2%; padding-right: 2%;">
    <div class="row">
        <div class="col-md-12">
            <h2 id="viewdb" style="margin-top: 10px;">
                <div class="pull-left">
                    <div>
                        <a class="blackLink" href="/[[ .Meta.Owner ]]">[[ .Meta.Owner ]]</a> /
                        <a class="blackLink" href="/[[ .Meta.Owner ]]/[[ .Meta.Database ]]">[[ .Meta.Database ]]</a>
                    </div>
                    [[ if .Meta.ForkOwner ]]
                    <div style="font-size: small">
                        forked from <a href="/[[ .Meta.ForkOwner ]]">[[ .Meta.ForkOwner ]]</a> /
                        [[ if not .Meta.ForkDeleted ]]
                            <a href="/[[ .Meta.ForkOwner ]]/[[ .Meta.ForkDatabase ]]">[[ .Meta.ForkDatabase ]]</a>
                        [[ else ]]
                            deleted database
                        [[ end ]]
                    </div>
                    [[ end ]]
                </div>
                <div class="pull-right">
                    <div class="btn-group">
                        <button type="button" class="btn btn-default" ng-bind-html="watchersText" ng-click="toggleWatchers()"></button>
                        <button type="button" class="btn btn-default" ng-bind="meta.Watchers" ng-click="watchersPage()"></button>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-default" ng-bind-html="starsText" ng-click="toggleStars()"></button>
                        <button type="button" class="btn btn-default" ng-bind="meta.Stars" ng-click="starsPage()"></button>
                    </div>
                    <div class="btn-group">
                        [[ if ne .Meta.Owner .Meta.LoggedInUser ]]
                            <button type="button" class="btn btn-default" ng-click="forkDB()"><i class="fa fa-sitemap"></i> Fork</button>
                        [[ else ]]
                            <button type="button" class="btn btn-default" ng-disabled="true"><i class="fa fa-sitemap"></i> Fork</button>
                        [[ end ]]
                        <button type="button" class="btn btn-default" ng-bind="meta.Forks" ng-click="forksPage()"></button>
                    </div>
                </div>
            </h2>
        </div>
    </div>
    <div class="row" style="padding-bottom: 5px; padding-top: 10px;">
        <div class="col-md-6">
            <label id="viewdata" style="font-weight: 600; font-family: 'arial black';"><a href="/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" title="Data"><i class="fa fa-database"></i> Data</a></label> &nbsp; &nbsp; &nbsp;
            <label id="viewvis" style="font-weight: 600; font-family: 'arial black'; border-bottom: 1px grey dashed;"><i class="fa fa-bar-chart"></i> Visualise</label> &nbsp; &nbsp; &nbsp;
            <label id="viewdiscuss" style="font-weight: 600; font-family: 'arial black';"><a href="/discuss/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" title="Discussions"><i class="fa fa-commenting"></i> Discussions:</a> {{ meta.Discussions }}</label> &nbsp; &nbsp; &nbsp;
            <label id="viewmrs" style="font-weight: 600; font-family: 'arial black';"><a href="/merge/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" title="Merge Requests"><i class="fa fa-clone"></i> Merge Requests: </a>{{ meta.MRs }}</label> &nbsp; &nbsp; &nbsp;
            [[ if eq .Meta.Owner .Meta.LoggedInUser ]]
            <label id="settings" style="font-weight: 600; font-family: 'arial black';"><a class="blackLink" href="/settings/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"><i class="fa fa-cog"></i> Settings</a></label>
            [[ end ]]
        </div>
        <div class="col-md-6">
            <div class="pull-right">
                [[ if eq .Meta.Owner .Meta.LoggedInUser ]]
                    <b>Visibility:</b> <a class="blackLink" href="/settings/[[ .Meta.Owner ]]/[[ .Meta.Database ]]">{{ meta.Public }}</a> &nbsp;
                [[ else ]]
                    <b>Visibility:</b> {{ meta.Public }} &nbsp;
                [[ end ]]
                <b>Commit:</b> {{ meta.CommitID | limitTo: 8 }} &nbsp;
                [[ if eq .Meta.Owner .Meta.LoggedInUser ]]
                    <b>Licence:</b> <a class="blackLink" href="/settings/[[ .Meta.Owner ]]/[[ .Meta.Database ]]">{{ meta.Licence }}</a> &nbsp;
                [[ else ]]
                    [[ if ne .DB.Info.LicenceURL "" ]]
                        <b>Licence:</b> <a class="blackLink" href="{{ meta.LicenceURL }}">{{ meta.Licence }}</a> &nbsp;
                    [[ else ]]
                        <b>Licence:</b> {{ meta.Licence }} &nbsp;
                    [[ end ]]
                [[ end ]]
                <b>Size:</b> {{ meta.Size / 1024 | number : 0 }} KB
            </div>
        </div>
    </div>
    [[ if or (ne .DB.Info.OneLineDesc "No description") ((ne .DB.Info.SourceURL "")) ]]
        <div class="row">
            <div class="col-md-12">
                <div class="well well-sm" style="margin-bottom: 10px; border: 1px solid #DDD; border-radius: 7px;">
                    [[ if (ne .DB.Info.OneLineDesc "No description") ]]
                        <label id="viewdesc" ng-bind="meta.OneLineDesc"></label>
                    [[ end ]]
                    [[ if (ne .DB.Info.SourceURL "") ]]
                        <div>
                            <label>Source:</label> <a href="{{ meta.SourceURL }}" ng-bind="meta.SourceURL"></a>
                        </div>
                    [[ end ]]
                </div>
            </div>
        </div>
    [[ end ]]
    <div class="row">
        <div class="col-md-12">
            <div style="border: 1px solid #DDD; border-radius: 7px; margin-bottom: 10px;">
                <table width="100%" class="table" style="margin-bottom: 0; border: none;">
                    <tr style="border: none;">
                        <td style="border: none; border-right: 1px solid #DDD;">
                            <div style="text-align: center;">
                                <a href="/commits/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?branch={{ meta.Branch }}" class="blackLink" style="font-weight: bold;">Commits: {{ meta.Commits }}</a>
                            </div>
                        </td>
                        <td style="border: none; border-right: 1px solid #DDD;">
                            <div style="text-align: center;">
                                <a href="/branches/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" style="font-weight: bold;">Branches: {{ meta.Branches }}</a>
                            </div>
                        </td>
                        <td style="border: none; border-right: 1px solid #DDD;">
                            <div style="text-align: center;">
                                <a href="/tags/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" style="font-weight: bold;">Tags: {{ meta.Tags }}</a>
                            </div>
                        </td>
                        <td style="border: none; border-right: 1px solid #DDD;">
                            <div style="text-align: center;">
                                <a href="/releases/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" style="font-weight: bold;">Releases: {{ meta.Releases }}</a>
                            </div>
                        </td>
                        <td style="border: none;">
                            <div style="text-align: center;">
                                <a href="/contributors/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="blackLink" style="font-weight: bold;">Contributors: {{ meta.Contributors }}</a>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="row" style="padding-bottom: 10px;">
        <div class="col-md-10">
            <span class="pull-left">
                <div class="dropdown">
                    <div class="btn-group" uib-dropdown keyboard-nav="true">
                        <button id="viewbranch" type="button" class="btn">{{ 'Branch: ' + meta.Branch }}</button>

                        <button type="button" uib-dropdown-toggle class="btn btn-default">
                            <span class="caret"></span>
                        </button>
                        <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                            <li ng-repeat="row in meta.BranchList" role="menuitem" ng-click="changeBranch(row)">
                                <a href="">{{ row }}</a>
                            </li>
                        </ul>
                    </div>
                    [[ if .Meta.LoggedInUser ]]
                        <a href="/compare/[[ .Meta.Owner ]]/[[ .Meta.Database ]]" class="btn btn-primary">New Merge Request</a>
                    [[ end ]]
                </div>
            </span>
        </div>
        <div class="col-md-2">
            <span class="pull-right">
                <!-- <button class="btn btn-primary" ng-click="uploadForm()">Upload database</button> -->
                <div class="btn-group" uib-dropdown keyboard-nav="true">
                    <button type="button" class="btn btn-success" uib-dropdown-toggle>
                        Download database <span class="caret"></span>
                    </button>
                    <ul uib-dropdown class="dropdown-menu dropdown-menu-right" role="menu">
                        <li><a href="/x/download/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]">Entire database ({{ meta.Size / 1024 | number : 0 }} KB)</a></li>
                    </ul>
                </div>
            </span>
        </div>
    </div>
    <div class="row">
        <div class="col-md-2">&nbsp;</div>
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-12">
                    <h3 style="text-align: center;">Please choose the X and Y axes to visualise</h3>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-striped table-responsive settingsTable">
                        <tr>
                            <th width="35%">First axis table</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="viewtable" type="button" class="btn">Table/view: {{ XTablename }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in meta.Tables" role="menuitem" ng-click="changeXAxisTable(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th width="35%">First axis column</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ XAxisColumn }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in XColumnNames" role="menuitem" ng-click="changeXAxisColumn(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <table class="table table-striped table-responsive settingsTable">
                        <tr>
                            <th>Second axis table</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="viewtable" type="button" class="btn">Table/view: {{ YTablename }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in meta.Tables" role="menuitem" ng-click="changeYAxisTable(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th width="35%">Second axis column</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ YAxisColumn }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in YColumnNames" role="menuitem" ng-click="changeYAxisColumn(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div ng-show="showJoinChooser === true" class="row">
                        <div class="col-md-12">
                            <h3 style="text-align: center;">JOIN type for the tables</h3>
                        </div>
                    </div>
                    <table ng-show="showJoinChooser === true" class="table table-striped table-responsive settingsTable">
                        <tr>
                            <th width="35%">Join type</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ JoinType }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in joinTypes" role="menuitem" ng-click="changeJoinType(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr ng-show="JoinType === 'INNER JOIN' || JoinType === 'LEFT OUTER JOIN'">
                            <th width="35%">ON clause</th>
                            <td>{{ XTablename }}.<div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ JoinXColumn }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="col in XColumnNames" role="menuitem" ng-click="changeJoinXColumn(col)">
                                            <a href="">{{ col }}</a>
                                        </li>
                                    </ul>
                                </div>
                            = {{ YTablename }}.<div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ JoinYColumn }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="col in YColumnNames" role="menuitem" ng-click="changeJoinYColumn(col)">
                                            <a href="">{{ col }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div class="row">
                        <div class="col-md-12">
                            <h3 style="text-align: center;">Do you want to use an aggregate function on the second axis? (<a href="https://www.sqlite.org/lang_aggfunc.html" target="_blank">info</a>)</h3>
                        </div>
                    </div>

                    <table class="table table-striped table-responsive settingsTable">
                        <tr>
                            <th width="35%">Aggregate function?</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ AggType }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li ng-repeat="row in aggTypes" role="menuitem" ng-click="changeAggType(row)">
                                            <a href="">{{ row }}</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div class="row">
                        <div class="col-md-12">
                            <h3 style="text-align: center;">Generated SQL</h3>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <textarea id="sql" rows="4"></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h3 style="text-align: center;">Chart settings</h3>
                        </div>
                    </div>

                    <table class="table table-striped table-responsive settingsTable">
                        <tr>
                            <th width="35%">Chart type</th>
                            <td>
                                <div class="btn-group" uib-dropdown keyboard-nav="true">
                                    <button id="orderby" type="button" class="btn">{{ ChartType }}</button>

                                    <button type="button" uib-dropdown-toggle class="btn btn-default">
                                        <span class="caret"></span>
                                    </button>
                                    <ul uib-dropdown-menu class="dropdown-menu" role="menu">
                                        <li role="menuitem">
                                            <a href="" ng-click="chartChangeType('hbc')">Horizontal bar chart</a>
                                            <a href="" ng-click="chartChangeType('vbc')">Vertical bar chart</a>
                                            <a href="" ng-click="chartChangeType('lc')">Line chart</a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <div class="row" ng-if="statusMessage != ''">
                        <div style="text-align: center; padding-bottom: 8px;">
                            <h4 style="color: {{ statusMessageColour }};">&nbsp;{{ statusMessage }}</h4>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <input type="submit" class="btn btn-success" value="Display" ng-click="doVis()">
                        [[ if eq .Meta.Owner .Meta.LoggedInUser ]]
                        <input type="submit" class="btn btn-primary" value="Save as default" ng-click="saveAs('default')">
                        [[ end ]]
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">&nbsp;</div>
    </div>
    <div class="row" style="border: none;">
        &nbsp;
    </div>
    <div ng-show="showVis === true" class="row">
        <div class="col-md-12">
            <div id="vis" style="width:100%;"></div>
        </div>
    </div>
    <div class="row" style="border: none;">
        &nbsp;
    </div>
    <div id="descdiv" class="row" style="border: none;">
        <div class="col-md-12" style="border: none;">
            <div style="border: 1px solid #DDD; border-radius: 7px; padding: 1px;">
                <table class="table table-striped table-responsive" style="margin: 0;">
                    <tr style="border-bottom: 1px solid #DDD;">
                        <td class="page-header" style="border: none;"><h4>DESCRIPTION</h4></td>
                    </tr>
                    <tr>
                        <td class="rendered" id="viewreadme" ng-bind-html="meta.FullDesc"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="row">
        &nbsp;
    </div>
</div>
[[ template "footer" . ]]
<script>
    // Pre-filled table row data
    let barChartData = {
        XTablename: "[[ .XAxisTable ]]",
        YTablename: "[[ .YAxisTable ]]",
        XAxisLabel: "",
        YAxisLabel: "",
        Records: [[ .Records ]],
    }
    let dataReceived = false;

    // Remove any database file extension from the chart title
    let plotTitle = "[[ .Meta.Database ]]";
    if (plotTitle.endsWith(".sqlite")) {
        barChartData.Title = plotTitle.replace(/\.sqlite$/, "");
    }
    if (plotTitle.endsWith(".sqlite3")) {
        barChartData.Title = plotTitle.replace(/\.sqlite3$/, "");
    }
    if (plotTitle.endsWith(".db")) {
        barChartData.Title = plotTitle.replace(/\.db$/, "");
    }
    if (plotTitle.endsWith(".db3")) {
        barChartData.Title = plotTitle.replace(/\.db3$/, "");
    }

    // Plotly pieces
    let plotData = [
        {
            type: "bar",
            orientation: "v"
        }
    ];
    let plotLayout = {};
    let plotConfig = {
        watermark: false,
        displaylogo: false
    };

    // * AngularJS pieces start here *

    // Simple filter to ensure '&nbsp;' is shown as a non-breaking space
    var app = angular.module('DBHub', ['ui.bootstrap', 'ngSanitize']);
    app.filter("fixSpaces", ['$sce', '$sanitize', function($sce, $sanitize) {
        return function(htmlCode) {
            if (htmlCode === "") {
                htmlCode = '&nbsp;';
            }
            return $sanitize(htmlCode);
        }
    }]);

    app.controller('visualiseView', function($scope, $http) {
        // Pre-filled database metadata
        $scope.meta = {
            Branch:       "[[ .DB.Info.Branch ]]",
            Branches:     "[[ .DB.Info.Branches ]]",
            BranchList:   [[ .DB.Info.BranchList ]],
            CommitID:     "[[ .DB.Info.CommitID ]]",
            Commits:      "[[ .DB.Info.Commits ]]",
            Contributors: "[[ .DB.Info.Contributors ]]",
            Database:     "[[ .Meta.Database ]]",
            Discussions:  "[[ .DB.Info.Discussions ]]",
            Forks:        "[[ .DB.Info.Forks ]]",
            FullDesc:     "[[ .DB.Info.FullDesc ]]",
            Licence:      "[[ .DB.Info.Licence ]]",
            LicenceURL:   "[[ .DB.Info.LicenceURL ]]",
            MRs:          "[[ .DB.Info.MRs ]]",
            MyStar:       "[[ .MyStar ]]",
            MyWatch:      "[[ .MyWatch ]]",
            OneLineDesc:  "[[ .DB.Info.OneLineDesc ]]",
            Owner:        "[[ .Meta.Owner ]]",
            Public:       "",
            Releases:     "[[ .DB.Info.Releases ]]",
            Size:         "[[ .DB.Info.DBEntry.Size ]]",
            SourceURL:    "[[ .DB.Info.SourceURL ]]",
            Stars:        "[[ .DB.Info.Stars ]]",
            Watchers:     "[[ .DB.Info.Watchers ]]",
            Tables:       [[ .DB.Info.Tables ]],
            Tags:         "[[ .DB.Info.Tags ]]",
            [[ if .Meta.LoggedInUser ]]
                Loggedin: "true",
            [[ else ]]
                Loggedin: "false",
            [[ end ]]
        }

        // Set the table names
        $scope.XTablename = "[[ .XAxisTable ]]";
        $scope.YTablename = "[[ .YAxisTable ]]";

        // Set the displayed public/private value
        if ("[[ .DB.Info.Public ]]" === "true") {
            $scope.meta.Public = "Public";
        } else {
            $scope.meta.Public = "Private";
        }

        // Display a Plotly chart
        $scope.doChart = function(updateData) {
            // Recreate the layout structure, to ensure the plot is fully redrawn.  Without this, the chart info is
            // drawn all mixed up, even with newPlot() :(
            plotLayout = {
                title: barChartData.Title,
                autosize: true,
                width: document.getElementById("descdiv").offsetWidth,
                xaxis: {
                    visible: true,
                },
                yaxis: {
                    visible: true,
                },
            };

            // Reorganise the bar chart data horizontally or vertically
            if (updateData && (barChartData.Records != null)) {
                let tmpData = barChartData.Records;
                plotData[0].x = [];
                plotData[0].y = [];
                if (plotData[0].orientation === "v") {
                    for (num = 0; num < tmpData.length; num++) {
                        let name = tmpData[num]["Name"];
                        let val = tmpData[num]["Value"];
                        plotData[0].x.push(name);
                        plotData[0].y.push(val);
                    }
                } else {
                    for (num = 0; num < tmpData.length; num++) {
                        let name = tmpData[num]["Name"];
                        let val = tmpData[num]["Value"];
                        plotData[0].x.push(val);
                        plotData[0].y.push(name);
                    }
                }
            }

            // Update axis titles
            if (plotData[0].orientation === "v") {
                plotLayout.xaxis.title = { text: barChartData.XAxisLabel};
                plotLayout.yaxis.title = { text: barChartData.YAxisLabel};
            } else {
                plotLayout.xaxis.title = { text: barChartData.YAxisLabel};
                plotLayout.yaxis.title = { text: barChartData.XAxisLabel};
            }

            // Redraw the chart
            Plotly.react("vis", plotData, plotLayout, plotConfig);
        };

        // Start out with the visualisation disabled, unless saved parameters were passed through
        $scope.showVis = false;
        $scope.XColumnNames = [[ .XAxisColNames ]];
        $scope.XAxisColumn = $scope.XColumnNames[0];
        barChartData.XAxisLabel = $scope.XAxisColumn;
        $scope.YColumnNames = [[ .YAxisColNames ]];
        $scope.YAxisColumn = $scope.YColumnNames[1];
        barChartData.YAxisLabel = $scope.YAxisColumn;
        $scope.AggType = "---";
        $scope.aggTypes = ["---", "avg", "count", "group_concat", "max", "min", "sum", "total"];

        // Set up chart type
        $scope.ChartType = "[[ .ChartType ]]";
        if ($scope.ChartType === "") { $scope.ChartType = "Vertical bar chart"; } // Set a default type if no saved data passed
        switch ($scope.ChartType) {
            case "Horizontal bar chart":
                plotData[0].type = "bar";
                plotData[0].orientation = "h";
                break;
            case "Vertical bar chart":
                plotData[0].type = "bar";
                plotData[0].orientation = "v";
                break;
            case "Line chart":
                plotData[0].type = "scatter";
                plotData[0].orientation = "v";
                break;
        }

        // JOIN chooser pieces
        $scope.showJoinChooser = false;
        if ($scope.XTablename !== $scope.YTablename) {
            $scope.showJoinChooser = true;
        }
        $scope.JoinType = "[[ .JoinType ]]";
        $scope.joinTypes = ["---", "INNER JOIN", "LEFT OUTER JOIN"];
        // $scope.joinTypes = ["---", "INNER JOIN", "LEFT OUTER JOIN", "CROSS JOIN"];
        $scope.JoinXColumn = "";
        $scope.JoinYColumn = "";
        if ($scope.JoinType === "INNER JOIN" || $scope.JoinType === "LEFT OUTER JOIN") {
            $scope.JoinXColumn = $scope.XColumnNames[0];
            $scope.JoinYColumn = $scope.YColumnNames[0];
        }

        // Change the type of chart
        $scope.chartChangeType = function(newType) {
            switch (newType) {
                case "hbc":
                    plotData[0].type = "bar";
                    plotData[0].orientation = "h";
                    $scope.ChartType = "Horizontal bar chart";
                    break;
                case "vbc":
                    plotData[0].type = "bar";
                    plotData[0].orientation = "v";
                    $scope.ChartType = "Vertical bar chart";
                    break;
                case "lc":
                    plotData[0].type = "scatter";
                    plotData[0].orientation = "v";
                    $scope.ChartType = "Line chart";
            }
            $scope.doChart(true);
        };

        // If saved parameter data was passed through, update the initial values
        if ("[[ .ParamsGiven ]]" === "true") {
            $scope.XTablename = "[[ .XAxisTable ]]";
            $scope.XAxisColumn = "[[ .XAxisCol ]]";
            barChartData.XAxisLabel = $scope.XAxisColumn;
            $scope.YTablename = "[[ .YAxisTable ]]";
            $scope.YAxisColumn = "[[ .YAxisCol ]]";
            barChartData.YAxisLabel = $scope.YAxisColumn;
            $scope.AggType = "[[ .AggType ]]";
        }

        // If the data points for visualisation were provided, set the flag to indicate this
        if ("[[ .DataGiven ]]" === "true") {
            dataReceived = true;
        }

        // If both the visualisation parameters and data points were provided, set the flag to show the visualisation
        if (("[[ .ParamsGiven ]]" === "true") && ("[[ .DataGiven ]]" === "true")) {
            $scope.showVis = true;
            $scope.doChart(true);
        }

        // Handle browser resize events
        function resizeEvent() {
            if (dataReceived === true) {
                $scope.doChart(false);
            }
        }
        window.onresize = resizeEvent; // Redraw the bar chart when the window is resized

        // Retrieve the data for visualisation
        $scope.doVis = async function() {
            let args = "xtable=" + $scope.XTablename;
            args += "&ytable=" + $scope.YTablename;
            args += "&xaxis=" + $scope.XAxisColumn;
            args += "&yaxis=" + $scope.YAxisColumn;
            args += "&agg=" + $scope.AggType;
            if ($scope.XTablename !== $scope.YTablename) {
                // The user has selected a join of some sort
                if ($scope.JoinType === "---") {
                    // Can't retrieve valid data until viable JOIN pieces are selected
                    $scope.showVis = false;
                    return;
                }

                args += "&join=" + $scope.JoinType;
                if ($scope.JoinType === "INNER JOIN" || $scope.JoinType === "LEFT OUTER JOIN") {
                    args += "&joinxcol=" + $scope.JoinXColumn;
                    args += "&joinycol=" + $scope.JoinYColumn;
                }
            }
            $http.get("/x/vis/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]&"+args).then(
                function success(response) {
                    // Clear any existing error message
                    $scope.statusMessage = "";

                    // Update table data
                    barChartData.Records = response.data;
                    barChartData.XTablename = $scope.XTablename;
                    barChartData.YTablename = $scope.YTablename;
                    barChartData.XAxisLabel = $scope.XAxisColumn;
                    barChartData.YAxisLabel = $scope.YAxisColumn;

                    // Display the visualisation
                    $scope.showVis = true;
                    dataReceived = true;
                    $scope.doChart(true);

                    // Clear any existing status message
                    $scope.statusMessage = "";
                }, function failure(response) {
                    // Retrieving data failed, so display the returned error message and hide the graph
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Retrieving data failed: " + response.data;
                    $scope.showVis = false;
                }
            )
        };

        // Save the visualisation for easy later retrieval
        $scope.statusMessage = "";
        $scope.statusMessageColour = "red";
        $scope.saveAs = function(visName) {
            let args = "xtable=" + $scope.XTablename;
            args += "&ytable=" + $scope.YTablename;
            args += "&xaxis=" + $scope.XAxisColumn;
            args += "&yaxis=" + $scope.YAxisColumn;
            args += "&visname=" + visName;
            switch ($scope.ChartType) {
                case "Horizontal bar chart":
                    args += "&charttype=hbc";
                    break;
                case "Vertical bar chart":
                    args += "&charttype=vbc";
                    break;
                case "Line chart":
                    args += "&charttype=lc";
                    break;
            }
            args += "&agg=" + $scope.AggType;
            if ($scope.XTablename !== $scope.YTablename) {
                // The user has selected a join of some sort
                if ($scope.JoinType === "---") {
                    // Can't save until viable JOIN pieces are selected
                    return;
                }

                args += "&join=" + $scope.JoinType;
                if ($scope.JoinType === "INNER JOIN" || $scope.JoinType === "LEFT OUTER JOIN") {
                    args += "&joinxcol=" + $scope.JoinXColumn;
                    args += "&joinycol=" + $scope.JoinYColumn;
                }
            }
            $http.get("/x/vissave/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]&"+args).then(
                function success(response) {
                    $scope.statusMessageColour = "green";
                    $scope.statusMessage = "Visualisation '" + visName + "' saved";
                }, function failure(response) {
                    // The save failed, so display the returned error message
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Saving failed: " + response.data;
                }
            )
        };

        // Update the generated SQL display
        $scope.updateSQL = function() {
            // Update the generated SQL display
            let sqlWindow = document.getElementById("sql");
            if ($scope.XTablename === $scope.YTablename) {
                if ($scope.AggType === "---") {
                    sqlWindow.innerHTML = "SELECT\n    " +
                        $scope.XAxisColumn + ", " + $scope.YAxisColumn + "\n" +
                        "FROM\n    " + $scope.XTablename + ";";
                    sqlWindow.rows = 4;
                } else {
                    sqlWindow.innerHTML = "SELECT\n    " +
                        $scope.XAxisColumn + ", " + $scope.AggType + "(" + $scope.YAxisColumn + ")\n" +
                        "FROM\n    " + $scope.XTablename + "\n" +
                        "GROUP BY " + $scope.XAxisColumn + ";";
                    sqlWindow.rows = 5;
                }
            } else {
                 let joinText = "SELECT\n    " +
                    $scope.XTablename + "." + $scope.XAxisColumn + ", " +
                    $scope.YTablename + "." + $scope.YAxisColumn + "\n";
                if ($scope.JoinType === "---") {
                    // No JOIN
                    joinText = "Please choose JOIN type and columns";
                } else if ($scope.JoinType === "INNER JOIN") {
                    // INNER JOIN
                    joinText += "FROM\n    " + $scope.XTablename + " INNER JOIN " + $scope.YTablename + " ON " +
                        $scope.XTablename + "." + $scope.JoinXColumn + " = " + $scope.YTablename + "." + $scope.JoinYColumn + ";";
                } else if ($scope.JoinType === "LEFT OUTER JOIN") {
                    // LEFT OUTER JOIN
                    joinText += "FROM\n    " + $scope.XTablename + " LEFT OUTER JOIN " + $scope.YTablename + " ON " +
                        $scope.XTablename + "." + $scope.JoinXColumn + " = " + $scope.YTablename + "." + $scope.JoinYColumn + ";";
                } else {
                    joinText += "FROM\n    " + $scope.XTablename + " " + $scope.JoinType + " " + $scope.YTablename + ";";
                }
                sqlWindow.innerHTML = joinText;
                sqlWindow.rows = 4;
            }
        }
        // Display the initial generated SQL
        $scope.updateSQL();

        // Change the X Axis table
        $scope.changeXAxisTable = function(newtable) {
            $scope.XTablename = newtable;
            // Retrieve the column names for the new table
            $http.get("/x/table/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]&table="+
                newtable).then(
                function success(response) {
                    // Display the join chooser if needed
                    if ($scope.XTablename === $scope.YTablename) {
                        $scope.showJoinChooser = false;
                    } else {
                        $scope.showJoinChooser = true;
                    }

                    // Update X axis columns
                    $scope.showVis = true;
                    $scope.XColumnNames = response.data.ColNames;
                    $scope.changeXAxisColumn($scope.XColumnNames[0]);
                }, function failure(response) {
                    // Retrieving column names failed, so display the returned error message
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Retrieving column names failed: " + response.data;
                    $scope.showVis = false;
                }
            )
        };

        // Change the X Axis Column
        $scope.changeXAxisColumn = function(newcol) {
            $scope.XAxisColumn = newcol;
            $scope.updateSQL();

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Change the Y Axis table
        $scope.changeYAxisTable = function(newtable) {
            $scope.YTablename = newtable;
            // Retrieve the column names for the new table
            $http.get("/x/table/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]&table="+
                newtable).then(
                function success(response) {
                    // Display the join chooser if needed
                    if ($scope.XTablename === $scope.YTablename) {
                        $scope.showJoinChooser = false;
                    } else {
                        $scope.showJoinChooser = true;
                    }

                    // Update Y axis columns
                    $scope.showVis = true;
                    $scope.YColumnNames = response.data.ColNames;
                    $scope.changeYAxisColumn($scope.YColumnNames[0]);
                }, function failure(response) {
                    // Retrieving column names failed, so display the returned error message
                    $scope.statusMessageColour = "red";
                    $scope.statusMessage = "Retrieving column names failed: " + response.data;
                    $scope.showVis = false;
                }
            )
        };

        // Change the Y Axis Column
        $scope.changeYAxisColumn = function(newcol) {
            $scope.YAxisColumn = newcol;
            $scope.updateSQL();

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Change the Aggregate function
        $scope.changeAggType = function(newagg) {
            $scope.AggType = newagg;
            $scope.updateSQL();

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Change the SQLite JOIN type
        $scope.changeJoinType = function(newjoin) {
            $scope.JoinType = newjoin;
            $scope.updateSQL();

            if ($scope.JoinType === "INNER JOIN") {
                $scope.JoinXColumn = $scope.XColumnNames[0];
                $scope.JoinYColumn = $scope.YColumnNames[0];
            }

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Change the JOIN X axis column
        $scope.changeJoinXColumn = function(col) {
            $scope.JoinXColumn = col;
            $scope.updateSQL();

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Change the JOIN Y axis column
        $scope.changeJoinYColumn = function(col) {
            $scope.JoinYColumn = col;
            $scope.updateSQL();

            // If the graph is being shown, update it
            if ($scope.showVis === true) {
                $scope.doVis();
            }
        };

        // Fork the database
        $scope.forkDB = function() {
            // Check if the user is logged in
            if ($scope.meta.Loggedin !== "true") {
                // User needs to be logged in
                lock.show();
                return;
            }

            // Only proceed if the database being forked doesn't already belong to the user
            if ("[[ .Meta.LoggedInUser ]]" !== "[[ .Meta.Owner ]]") {
                // Call the fork database code, which should bounce us to the forked database
                window.location = "/x/forkdb/[[ .Meta.Owner ]]/[[ .Meta.Database ]]?commit=[[ .DB.Info.CommitID ]]";
            }
        };

        // Sends the user to the forks page for the database
        $scope.forksPage = function() {
            window.location = "/forks/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Sends the user to the stars page for the database
        $scope.starsPage = function() {
            window.location = "/stars/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Sends the user to the login page (if not logged in), else toggles starring of the database for the user
        $scope.toggleStars = function() {
            if ($scope.meta.Loggedin !== "true") {
                // User needs to be logged in
                lock.show();
                return;
            }
            $http.get("/x/star/[[ .Meta.Owner ]]/[[ .Meta.Database ]]")
                .then(function (response) {
                    var tempval = response.data;
                    if (tempval !== "-1") {
                        // Update star button text
                        if ($scope.meta.MyStar !== "true") {
                            $scope.meta.MyStar = "true";
                        } else {
                            $scope.meta.MyStar = "false";
                        }
                        $scope.updateStarsText();

                        // Update displayed star count
                        $scope.meta.Stars = tempval;
                    }
                })
        };

        // Turns on watching for a database
        $scope.toggleWatchers = function() {
            if ($scope.meta.Loggedin !== "true") {
                // User needs to be logged in
                lock.show();
                return;
            }

            // Retrieve the branch list for the newly selected database
            $http.get("/x/watch/[[ .Meta.Owner ]]/[[ .Meta.Database ]]")
                .then(function (response) {
                    // Update watch button text
                    if ($scope.meta.MyWatch !== "true") {
                        $scope.meta.MyWatch = "true";
                    } else {
                        $scope.meta.MyWatch = "false";
                    }
                    $scope.updateWatchersText();

                    // Update displayed watcher count
                    $scope.meta.Watchers = response.data;
                });
        };

        // Update star button text to say "Stars" or "Unstar"
        $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
        $scope.updateStarsText = function() {
            if ($scope.meta.MyStar !== "true") {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Star";
            } else {
                $scope.starsText = "<i class=\"fa fa-star\"></i> Unstar";
            }
        };
        $scope.updateStarsText();

        // Update watchers button text to say "Watch" or "Unwatch"
        $scope.watchersText = "<i class=\"fa fa-eye\"></i> Watch";
        $scope.updateWatchersText = function() {
            if ($scope.meta.MyWatch !== "true") {
                $scope.watchersText = "<i class=\"fa fa-eye\"></i> Watch";
            } else {
                $scope.watchersText = "<i class=\"fa fa-eye\"></i> Unwatch";
            }
        };
        $scope.updateWatchersText();

        // Sends the user to the watchers page for the database
        $scope.watchersPage = function() {
            window.location = "/watchers/[[ .Meta.Owner ]]/[[ .Meta.Database ]]"
        };

        // Auth0 authentication
        var lock = new Auth0Lock("[[ .Auth0.ClientID ]]", "[[ .Auth0.Domain ]]", { auth: {
            redirectUrl: "[[ .Auth0.CallbackURL]]"
        }});
        $scope.showLock = function() {
            lock.show();
        };
    });
</script>
</body>
</html>
[[ end ]]
